<template name="ViewAdmission">
	{{#if Template.subscriptionsReady}}

	{{getSummary}}

	<h3> {{> patInfo patient=patient}} {{patient.currentBed.fullName}} </h3>
	<h4> {{admission.reason }}   Admitted on: {{datef admission.created}} </h4> 
	<button class="btn visit">New Visit</button> 
	<button class="btn btn-primary" 
				data-toggle="collapse" data-target="#editCondition">{{admission.condition}}</button>

	<div class="collapse" id="editCondition">
	{{> quickForm collection="Admissions" id="editConditionForm" type="update" doc=admission 
	autosave=true fields="condition"}} 
	</div>
			 
	<ul class="nav nav-tabs">
		<li class="active"><a data-toggle="tab" href="#visits">Visits</a></li>
		<li><a data-toggle="tab" href="#script">Script</a></li>
		
		<li><a data-toggle="tab" href="#todos">Todos</a></li>
		<li><a data-toggle="tab" href="#labs">Labs</a></li>
		<li><a data-toggle="tab" href="#testResults">Tests</a></li>
		<li><a data-toggle="tab" href="#measurements">Measurements</a></li>

		<li><a data-toggle="tab" href="#ptGraphs">Graphs</a></li>
		<li><a data-toggle="tab" href="#invoice">Invoice</a></li>
	</ul>

	<div class="tab-content">
		

		<div id="visits" class="tab-pane fade in active">
			<article class="recipe">
				<br/>
				{{#if isEditMode }} 
					{{> updateAdmissionForm admission=admission }} 
				{{else}} 
					{{#if admission.eligibleForDischarge}}
						<button class="btn-deny toggleDischarge">Remove eligible for discharge</button>
						
						<button class="btn-deny dischargePerform"  data-toggle="collapse" 
							data-target="#editDischarge">
							Perform Discharge
						</button> 
						
						<div class="collapse" id="editDischarge">
						{{> dischargeTmpl admission=admission}}
						</div>
						
					{{else}}
						<button class="btn-primary toggleDischarge">Make eligible for discharge</button> 
					{{/if}}

					<a href="/admitPatient/{{admission.patient}}" class="btn btn-primary"> Move Patient </a>

					<a href="/editAdmission/{{admission._id}}" class="btn btn-primary"> Edit  </a>

					<br/> <b>Admission Note</b> {{{admission.admissionNote}}}
					<hr/>
					<div class="panel-group">
						{{#each visits admission}}
						
						<div class="panel panel-default">
							<div class="panel-body">{{{note}}}</div>
							<div class="panel-footer">{{visitCreator}} - {{datef updatedAt}}</div>
						</div>
						{{/each}}
					</div>

					<i class="fa fa-trash"></i>
					<i class="fa fa-pencil"></i> 
				{{/if}}

			</article>
		</div>

		<div id="script" class="tab-pane fade ">
			<h3>Current Order </h3>
			{{> updateScriptForm admission=admission }} 
		</div>

		<div id="measurements" class="tab-pane fade ">
			{{> measurementTmpl admission=admission }} 
		</div>

		<div id="invoice" class="tab-pane fade">
			<br/>
			<table class="table table-striped table-bordered table-condensed">
				<tr style="background:navy; color: #ffd">
					<th>Bed</th>
					<th> From</th>
					<th> To</th>
					<th> Days</th>
					<th> Price</th>
					<th> Total</th>
				</tr>

				{{#each admission.bedStaysObj.stays}}
				<tr>
					<td>{{bed.fullName}}</td>
					<td> {{datef fromDate}} </td>
					<td> {{datef toDate}} </td>
					<td> {{days}} </td>
					<td> {{price}} </td>
					<td> {{total}} </td>
				</tr>
				{{/each}}
				<tr>
					<td colspan="6">
						<b> Total : {{ admission.bedStaysObj.total }}</b>
					</td>
				</tr>
			</table>

			<table class="table table-striped table-bordered table-condensed">
				<tr style="background:navy; color: #fff">
					<th>Service</th>
					<th> Units</th>
					<th> Price</th>
					<th> Date </th>
					<th> Total</th>
				</tr>
				{{#each admission.invoice.allItems}}
				<tr>
					<td>{{service}}</td>
					<td> {{units}} </td>
					<td> {{appliedPrice}} </td>
					<td> {{datef updatedAt}} </td>
					<td> {{total}} </td>
				</tr>
				{{/each}}
				<tr>
					<td colspan="6">
						<b> Total : {{ admission.invoice.totalCurrent }}</b>
					</td>
				</tr>
			</table>

			<button class="btn btn-primary" 
				data-toggle="collapse" data-target="#editInvoice">Edit Invoice</button>

			<div class="collapse" id="editInvoice">
				{{> quickForm collection="Invoices" id="editInvoiceForm" type=formType doc=currentInv 
			autosave=true omitFields="amountPaid, datePaid, paymentType"}} 
			</div>
			<br/>
			Bed Stay : Rs. <b> {{ admission.bedStaysObj.total }} </b>
			<br/> Grand Total : <b> Rs {{admission.invoice.grandTotal}}</b>
		</div>

		<div id="todos" class="tab-pane fade">
			{{> todosPt admission=admission}}
		</div>

		<div id="testResults" class="tab-pane fade">
			{{> testResults admission=admission}}
		</div>

		<div id="ptGraphs" class="tab-pane fade">
			{{> PtGraphs admission=admission}}
		</div>

		<div id="labs" class="tab-pane fade">
			{{> Labs admission=admission}}
		</div>

	</div>

	{{/if}}

</template>

<template name="updateAdmissionForm">
	<article class="recipe">
		{{> quickForm collection="Admissions" id="updateAdmissionForm" type="update" doc=admission
		fields="admissionNote, reason, admissionType"}}
	</article>
</template>

<template name="dischargeTmpl">
	<article class="recipe">
		{{#autoForm collection="Admissions" id="updateDischargeForm" type="update" doc=admission}}
		<fieldset>
			<legend>Discharge Patient</legend>
			{{> afQuickField name='dischargeSection.dischargeType' options="allowed" value="Recovered"}}
			
			{{#if afFieldValueIs name="dischargeSection.dischargeType" value="Referred"}}
    			{{> afQuickField name="referredTo"}}
  			{{/if}}

			{{> afQuickField name='dischargeSection.dischargeNote' }} 
		</fieldset>
		<button type="submit" class="btn btn-danger">Discharge</button> 
		{{/autoForm}}
	</article>
</template>

<template name="updateScriptForm">
	{{>scriptTbl script=admission.script}}
		<hr/>
		{{#autoForm collection="Admissions" id="updateAdmissionScriptForm" type="update" doc=admission }}
		 {{> afQuickField
		name='script'}}
		<button type="submit" class="btn btn-primary">Update</button> 
		{{/autoForm}}
</template>


<template name="main">

</template>


<template name="invoice">

</template>

<template name="todosPt">
	{{> tabular table=TabularTables.TodosPtTbl selector=selector class="table table-striped table-bordered table-condensed"}}

	{{> quickForm collection="Todos" id="newTodoForm" type="insert" fields="title, description, forUser"}} 
</template>

<template name="testResults">
	{{> tabular table=TabularTables.TestResultsAdmTbl selector=selector class="table table-striped table-bordered table-condensed"}}

	 <ul class="list-group">
		{{#each  admission.tests}}
			<li class="list-group-item">  
				{{name}} 
				{{#autoForm collection="TestResults" id="newTestResultsForm" type="insert"}}
				<fieldset>
					<legend>Update {{name}}</legend>
					{{> afQuickField name='labTest' value=_id readonly = true}}
					{{> afQuickField name='mainValue' }}
					{{> afQuickField name='values'}} 
				</fieldset>
				<button type="submit" class="btn btn-primary">Update</button> 
				{{/autoForm}}
			</li>
		{{/each}}
    </ul> 
</template>

<template name="Labs">
	{{> quickForm collection="Admissions" id="testsForm" type="update" 
		fields="labsAndImages" doc=admission autosave=true  }} 
</template>

<template name="measurementTmpl">
	{{> msmtTbl admission=admission}}
    {{> quickForm id="insertMeasurementForm" type="update-pushArray" collection="Admissions" 
      doc=admission scope="measurements"}}
</template>

<template name="msmtTbl">
	    {{#if admission.measurements}} 
        <table class="table table-striped table-bordered table-condensed">
            <tr style="background:#88a; color: #ffd">
                <th>Name</th>
                <th>Value</th>
				<th>Created</th>
				<th> </th>
            </tr>
            {{#each admission.measurements}}
            <tr>
                <td>{{measurement}}</td>
                <td> {{mainValue}} </td>
				 <td> {{datef updatedAt}} </td>
                <td> <button class="btn btn-deny deleteAllergy" name='{{drug}}' > Delete </button> </td>
            </tr>
            {{/each}} 
        </table>
    {{else}}
        <h3> No Measurements recorded yet. </h3>
    {{/if}}
</template>

<template name="PtGraphs">
	{{createChartData admission}}
	{{#each chartNames}}
		<div id={{.}}>{{drawChart .}}</div>
		<hr/>
		<br/>
	{{/each}}
</template>

